<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description"><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>(编译)关于package-lock.json的一切</title><link rel="shortcut icon" href="/images/avatar.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.png"></div><div class="author"><div class="author-name"><a href="/">小新</a></div><div class="about-me">Live free or die</div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">归档</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.png"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/codertx"></span><a href="https://github.com/codertx" target="_blank" title="https://github.com/codertx">https://github.com/codertx</a></li><li class="social-item"><span class="label"><img src="/images/socials/email.svg" alt="codert.sn@gmail.com"></span><span>codert.sn@gmail.com</span></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">(编译)关于package-lock.json的一切</div><div class="date">写于2018年01月09日</div><div class="content"><p>   文章编译自: <a href="https://medium.com/@Quigley_Ja/everything-you-wanted-to-know-about-package-lock-json-b81911aa8ab8" target="_blank" rel="external">Everything You Wanted To Know About package-lock.json But Were Too Afraid To Ask</a></p>
<p>你把npm更新到<code>v5.x.x</code>以后，会出现一种新的自动生成文件 - <code>Package-lock.json</code>。你如果打开这个文件，会发现它看着像<code>package.json</code>里面的依赖，不过看着更啰嗦。如果你不去管他，迟早你都会出现依赖的问题，比如依赖的版本没有安装正确。大多数人是直接删除掉<code>package-lock.json</code>，然后重新运行<code>npm install</code>来解决问题，这样也行，但是我们还是要搞清楚看这个文件是看什么的。</p>
<a id="more"></a>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>如果你用的是<code>npm^5.x.x</code>的版本，它默认就会生成<code>package-lock.json</code>这个文件</li>
<li>你应该使用<code>package-lock.json</code>来保证每次安装的依赖都是一样的</li>
<li>你应该把<code>package-lock.json</code>提交到版本控制库里面</li>
<li><code>npm^5.1.x</code>以后，<code>package.json</code>在某些情况下（文章后面会说）可以优先于<code>package-lock.json</code>，所以你应该不会那么头疼了。</li>
<li>不用先删除<code>package-lock.json</code>，只需要运行<code>npm install</code>就可以重新生成<code>package-lock.json</code></li>
<li>如果你的库提供了对外API，应该遵循<code>semver</code>规范来变更版本号</li>
</ul>
<h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>在你了解<code>package.json</code>和<code>package-lock.json</code>前，你需要先了解<a href="http://semver.org/" target="_blank" rel="external">semver 语义化版本号变更</a>。它是npm依赖管理背后的精髓。你可以点<a href="http://blog.npmjs.org/post/162134793605/why-use-semver" target="_blank" rel="external">这里</a>了解npm是如何使用它的。总的来说，所谓的语义化版本号变更，就是当你修改了你所维护的第三方库时，告诉那些使用了你的库的项目，你做的是哪种修改。一个版本号分为三个部分: X,Y,Z。X表示主版本号，Y表示次版本号，Z表示补丁更新。当你只是简单的修复了BUG，没有做任何新功能的添加，或者旧功能的修改，就需要更新补丁号（数值加一等等）。当你添加了新的功能，但没有破坏原有的功能，就需要更新次版本号。当你做了重大修改导致新版本不兼容旧的代码时，就需要更新主版本号。</p>
<h2 id="包管理"><a href="#包管理" class="headerlink" title="包管理"></a>包管理</h2><p>npm是为了更方便管理依赖。你的项目可能有上百个依赖，每个依赖本身又有上百个依赖。如果让你来记住这些依赖肯定会让你觉得想屎。所以npm诞生了，让你仅仅用几个命令就可以管理大量的依赖。</p>
<p>当你添加了一个依赖时，<code>package.json</code>里面会加一项条目，包含包的名称，并且使用semver来处理版本号。npm支持版本号中包含通配符。一般来说，npm会安装最新的版本的依赖，并且在版本号前面加上<code>^</code>符号，比如<code>^1.2.12</code>。这表示，至少要安装<code>1.2.12</code>的版本，但更高的版本也可以，只要主版本号也为1就行。因为补丁号和次版本号的变动不会变更已有的API。你应该可以安全地使用任何主版本一致的更高版本依赖。你可以点击<a href="http://blog.npmjs.org/post/115305091285/introducing-the-npm-semantic-version-calculator" target="_blank" rel="external">这里</a>的版本计算器，了解通配符的含义。</p>
<h2 id="项目共享"><a href="#项目共享" class="headerlink" title="项目共享"></a>项目共享</h2><p>把依赖记录在<code>package.json</code>里面的优点是，只要别人可以访问<code>package.json</code>，他就可以安装里面所记录的依赖，然后就可以直接运行你的项目了。不过有些时候，这样子会出现一个问题。</p>
<p>比如我们的项目用了express这个框架。我们使用<code>npm init</code>初始化项目后，使用命令<code>npm install express --save</code>安装了依赖。在写这篇文章的时候，express的版本号是<code>4.15.4</code>，所以<code>package.json</code>里面express的版本号会是<code>^4.15.4</code>，然后我的电脑上面就安装了版本为<code>4.15.4</code>的express。然后可能第二天，express的维护者修复了一个BUG，现在最新版本变成了<code>4.15.5</code>。接着，有个人觉得我们的项目很不错，他想贡献一些代码，于是它clone下来，运行了<code>npm install</code>。由于最新express版本是<code>4.15.5</code>，并且主版本号也是一致的，因此他的电脑上安装的版本就是<code>4.15.5</code>。我们都安装了express，但是版本却不一样。</p>
<p>理论上来说，这两个版本应该是兼容的，但是可能那个修复的BUG影响到了我们所使用的功能，使得在这两个不同的版本上出现不同运行结果。</p>
<h2 id="Package-lock-json"><a href="#Package-lock-json" class="headerlink" title="Package-lock.json"></a>Package-lock.json</h2><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p><code>package-lock.json</code>诞生的目的是为了防止出现我们上述的情况。同一个<code>package.json</code>却产生了不同的运行结果。<code>package-lock.json</code>在npm 5时添加进来，所以如果你使用5以上的版本，你就会看到这个文件，除非你手动禁用掉它。</p>
<h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><p><code>package.json</code>是一个包含你所有依赖的巨大列表，它包含明确的版本号（没有通配符），依赖的获取地址，一个用于验证完整性和正确性的哈希值，以及这个依赖本身所需要的依赖。我们来看一看express的<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="string">"express"</span>: &#123;</div><div class="line">  <span class="string">"version"</span>: <span class="string">"4.15.4"</span>,</div><div class="line">  <span class="string">"resolved"</span>: <span class="string">"https://registry.npmjs.org/express/-/express-4.15.4.tgz"</span>,</div><div class="line">  <span class="string">"integrity"</span>: <span class="string">"sha1-Ay4iU0ic+PzgJma+yj0R7XotrtE="</span>,</div><div class="line">  <span class="string">"requires"</span>: &#123;</div><div class="line">    <span class="string">"accepts"</span>: <span class="string">"1.3.3"</span>,</div><div class="line">    <span class="string">"array-flatten"</span>: <span class="string">"1.1.1"</span>,</div><div class="line">    <span class="string">"content-disposition"</span>: <span class="string">"0.5.2"</span>,</div><div class="line">    <span class="string">"content-type"</span>: <span class="string">"1.0.2"</span>,</div><div class="line">    <span class="string">"cookie"</span>: <span class="string">"0.3.1"</span>,</div><div class="line">    <span class="string">"cookie-signature"</span>: <span class="string">"1.0.6"</span>,</div><div class="line">    <span class="string">"debug"</span>: <span class="string">"2.6.8"</span>,</div><div class="line">    <span class="string">"depd"</span>: <span class="string">"1.1.1"</span>,</div><div class="line">    <span class="string">"encodeurl"</span>: <span class="string">"1.0.1"</span>,</div><div class="line">    <span class="string">"escape-html"</span>: <span class="string">"1.0.3"</span>,</div><div class="line">    <span class="string">"etag"</span>: <span class="string">"1.8.0"</span>,</div><div class="line">    <span class="string">"finalhandler"</span>: <span class="string">"1.0.4"</span>,</div><div class="line">    <span class="string">"fresh"</span>: <span class="string">"0.5.0"</span>,</div><div class="line">    <span class="string">"merge-descriptors"</span>: <span class="string">"1.0.1"</span>,</div><div class="line">    <span class="string">"methods"</span>: <span class="string">"1.1.2"</span>,</div><div class="line">    <span class="string">"on-finished"</span>: <span class="string">"2.3.0"</span>,</div><div class="line">    <span class="string">"parseurl"</span>: <span class="string">"1.3.1"</span>,</div><div class="line">    <span class="string">"path-to-regexp"</span>: <span class="string">"0.1.7"</span>,</div><div class="line">    <span class="string">"proxy-addr"</span>: <span class="string">"1.1.5"</span>,</div><div class="line">    <span class="string">"qs"</span>: <span class="string">"6.5.0"</span>,</div><div class="line">    <span class="string">"range-parser"</span>: <span class="string">"1.2.0"</span>,</div><div class="line">    <span class="string">"send"</span>: <span class="string">"0.15.4"</span>,</div><div class="line">    <span class="string">"serve-static"</span>: <span class="string">"1.12.4"</span>,</div><div class="line">    <span class="string">"setprototypeof"</span>: <span class="string">"1.0.3"</span>,</div><div class="line">    <span class="string">"statuses"</span>: <span class="string">"1.3.1"</span>,</div><div class="line">    <span class="string">"type-is"</span>: <span class="string">"1.6.15"</span>,</div><div class="line">    <span class="string">"utils-merge"</span>: <span class="string">"1.0.0"</span>,</div><div class="line">    <span class="string">"vary"</span>: <span class="string">"1.1.1"</span></div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>所以从此以后npm会根据<code>package-lock.json</code>里的内容来处理和安装依赖而不是根据<code>package.json</code>。因为<code>pacakge-lock.json</code>给每个依赖标明了版本，获取地址和哈希值，使得每次安装都会出现相同的结果。不管你在什么机器上面或什么时候安装。</p>
<h3 id="争议"><a href="#争议" class="headerlink" title="争议"></a>争议</h3><p>现在<code>package-lock.json</code>解决了一个经常遇到的难题，但为什么大家还是想把它禁用掉呢？</p>
<p>在npm 5以前，<code>package.json</code>是唯一的依赖数据源。<code>package.json</code>就是权威。npm用户喜欢这个样子并且已经习惯维护<code>package.json</code>文件。但是，当<code>package-lock.json</code>文件引入时，它和用户所期待的相反，对<code>package.json</code>所做的改动并不会反应到<code>package-lock.json</code>文件上。</p>
<p>例如：依赖A，在<code>package.json</code>和<code>package-lock.json</code>的版本号都为<code>1.0.0</code>。手动把<code>package.json</code>里A的版本号改为<code>1.1.0</code>，如果一个用户认为<code>npm install</code>会依据<code>package.json</code>来安装依赖，他们期望安装的版本是<code>1.1.0</code>，结果却安装了<code>1.0.0</code>。尽管<code>package.json</code>里面写的是<code>1.1.0</code></p>
<p>只因为用户不知道为什么他们的依赖没有按照预想当中样子安装，他们就宁愿禁用<code>package-lock.json</code>文件。</p>
<p>这个预想和现实中的冲突引发了一个特别有趣的<a href="https://github.com/npm/npm/issues/16866" target="_blank" rel="external">issue</a>。一些人支持<code>package.json</code>是依赖的权威来源，一些人支持<code>package-lock.json</code>。这个争议的解决方案在<a href="https://github.com/npm/npm/pull/17508" target="_blank" rel="external">PR #17508</a>。npm的维护者做了一个改动：当<code>package.json</code>文件有发生变更时，使用它作为依赖的来源。现在，不管在任何情况下，依赖安装都可以满足用户的预期了。这个改动发布于npm<code>v5.1.0</code>。</p>
</div><div class="tags"><a class="tag-link" href="/tags/javascript/">javascript</a><a class="tag-link" href="/tags/npm/">npm</a></div></section></div><div class="container"><ul class="nav"><li>上一篇：<a href="/2019/01/01/2018/">2018 总结</a></li><li>下一篇：<a href="/2018/01/08/why-coding/">反思一下最近的状况</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><span>Powered by </span><a href="http://hexo.io" target="_blank">Hexo</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" target="_blank">Bear</a><span>.</span></div></footer><script src="/script/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/script/index.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-138857294-1', 'auto');
ga('send', 'pageview');</script><script src="/script/post.js"></script></body></html>